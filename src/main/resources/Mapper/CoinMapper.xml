<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.diff._private.Mapper.CoinMapper">
	<select id="MainGridList" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker id, x.gijun_date, x.coin_kor_name, x.coin_eng_name, x.max_price, x.min_price, x.max_date, x.min_date, x.o_price, x.c_price, x.l_price, x.h_price, x.trade_volume
			 , coalesce(x.o_c_price_rate_5_date, '') o_c_price_rate_5_date, coalesce(x.o_c_price_rate_10_date, '') o_c_price_rate_10_date, coalesce(x.o_c_price_rate_15_date, '') o_c_price_rate_15_date
	 		 , coalesce(x.o_c_price_rate_20_date, '') o_c_price_rate_20_date, coalesce(x.o_c_price_rate_25_date, '') o_c_price_rate_25_date, coalesce(x.o_c_price_rate_30_date, '') o_c_price_rate_30_date
	 		 , coalesce(cast(x.o_c_price_rate_5_count as varchar), '0') o_c_price_rate_5_count, coalesce(cast(x.o_c_price_rate_10_count as varchar), '0') o_c_price_rate_10_count, coalesce(cast(x.o_c_price_rate_15_count as varchar), '0') o_c_price_rate_15_count
	 		 , coalesce(cast(x.o_c_price_rate_20_count as varchar), '0') o_c_price_rate_20_count, coalesce(cast(x.o_c_price_rate_25_count as varchar), '0') o_c_price_rate_25_count, coalesce(cast(x.o_c_price_rate_30_count as varchar), '0') o_c_price_rate_30_count
			 , cast((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,1)) as varchar) open_close_rate
			 , cast(ROUND(((((cast(x.max_price as numeric) - cast(x.min_price as numeric))/ cast(x.min_price as numeric))) * 100), 1) as varchar) lowest_highest_fluctuation
			 , cast(ROUND((((cast(x.c_price as numeric) / (cast(x.min_price as numeric) + cast(x.max_price as numeric)))) * 100), 1) as varchar) highest_lowest_100per
			 , cast((ROUND(((((cast(x.max_price as numeric) - cast(x.c_price as numeric)) / cast(x.max_price as numeric))) * 100), 1)) as varchar) highest_decline_rate
			 , cast((ROUND(((((cast(x.c_price as numeric) - cast(x.min_price as numeric)) / cast(x.min_price as numeric))) * 100), 1)) as varchar) lowest_rise_rate
		  from (
				select x.coin_ticker, y.coin_kor_name, y.coin_eng_name
					 , coalesce((select max(replace(a.datetime_kst, 'T09:00:00', '')) 
					 			   from upbit_coin_day a 
					 			  where a.coin_ticker = x.coin_ticker 
				 			     <if test='std_date != null and std_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								 </if>
								 <if test='end_date != null and end_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
								 </if>
					 			    and a.l_price = cast(min(cast(x.l_price as numeric)) as varchar)), '') min_date
			 		 , coalesce((select max(replace(a.datetime_kst, 'T09:00:00', '')) 
			 		 			   from upbit_coin_day a 
			 		 			  where a.coin_ticker = x.coin_ticker
			 		 			  <if test='std_date != null and std_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								  </if>
								  <if test='end_date != null and end_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
								  </if>
			 		 			    and a.h_price = cast(max(cast(x.h_price as numeric)) as varchar)), '') max_date
					 , case when position('.0' in cast(min(cast(x.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(x.l_price as numeric)) as varchar))-2) then replace((cast(min(cast(x.l_price as numeric)) as varchar)), '.0', '') else cast(min(cast(x.l_price as numeric)) as varchar) end  min_price
					 , case when position('.0' in cast(max(cast(x.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(x.h_price as numeric)) as varchar))-2) then replace((cast(max(cast(x.h_price as numeric)) as varchar)), '.0', '') else cast(max(cast(x.h_price as numeric)) as varchar) end  max_price
		             , (select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
		             	  from upbit_coin_day z 
		             	 where x.coin_ticker = z.coin_ticker 
		             	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		             	 order by z.datetime_kst desc 
		             	 limit 1) c_price
		             , (select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
		                  from upbit_coin_day z 
		                 where x.coin_ticker = z.coin_ticker 
		                 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		                 order by z.datetime_kst asc 
		                 limit 1) o_price
					 , (select case when position('.0' in cast(min(cast(z.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(z.l_price as numeric)) as varchar))-2) then replace(cast(min(cast(z.l_price as numeric)) as varchar), '.0', '') else cast(min(cast(z.l_price as numeric)) as varchar) end 
					 	  from upbit_coin_day z
					 	 where x.coin_ticker = z.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	 limit 1) l_price
		     		 , (select case when position('.0' in cast(max(cast(z.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(z.h_price as numeric)) as varchar))-2) then replace(cast(max(cast(z.h_price as numeric)) as varchar), '.0', '') else cast(max(cast(z.h_price as numeric)) as varchar) end 
		     		 	  from upbit_coin_day z 
		     		 	 where x.coin_ticker = z.coin_ticker 
		     		 	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		     		 	 limit 1) h_price
		 			 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	 order by a.datetime_kst desc 
					 	 limit 1) gijun_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 5 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_5_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 10 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_10_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 15 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_15_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 20 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_20_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 25 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_25_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 30 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_30_date
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 5) o_c_price_rate_5_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 10) o_c_price_rate_10_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 15) o_c_price_rate_15_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 20) o_c_price_rate_20_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 25) o_c_price_rate_25_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 30) o_c_price_rate_30_count
					 , (select case when cast(trade_volume as numeric) > 100000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000)) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 10000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000), 1) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 1000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000), 2) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 100000000 then cast(ROUND((cast(trade_volume as numeric)/1000000)) as varchar) || 'M'
						 			when cast(trade_volume as numeric) > 10000000 then cast(ROUND((cast(trade_volume as numeric)/1000000), 1) as varchar) || 'M'
									when cast(trade_volume as numeric) > 1000000 then cast(ROUND((cast(trade_volume as numeric)/1000000), 2) as varchar) || 'M'
									when cast(trade_volume as numeric) > 100000 then cast(ROUND((cast(trade_volume as numeric)/1000)) as varchar) || 'K'
									when cast(trade_volume as numeric) > 10000 then cast(ROUND((cast(trade_volume as numeric)/1000), 1) as varchar) || 'K'
								    else cast(ROUND((cast(trade_volume as numeric)/1000), 2) as varchar) || 'K' end 
						  from upbit_coin_day z 
						 where x.coin_ticker = z.coin_ticker 
						 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
						 order by z.datetime_kst desc limit 1)  trade_volume
				  from upbit_coin_day x, upbit_coin_info y
				 where x.coin_ticker = y.coin_ticker
				 <if test='std_date != null and std_date != "" '>
					and left(x.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
				 </if>
				 <if test='end_date != null and end_date != "" '>
					and left(x.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
				 </if>
				 group by x.coin_ticker, y.coin_kor_name, y.coin_eng_name
		 	   ) x
		  order by cast(x.c_price as numeric) desc
	</select>

	<select id="CoinInfo" resultType="HashMap">
		select x.coin_ticker, x.coin_kor_name, x.coin_eng_name, y.datetime_kst
			 , case when position('.0' in y.c_price) > (char_length(y.c_price)-2) then replace(y.c_price, '.0', '') else c_price end c_price 
		  from upbit_coin_info x
		  	 , (select y.coin_ticker, max(y.datetime_kst) datetime_kst
		  	 		 , (select cast(z.c_price as varchar) from upbit_coin_min z where y.coin_ticker = z.coin_ticker and max(y.datetime_kst) = z.datetime_kst) c_price
		  	 	  from upbit_coin_min y
		  	 	 group by y.coin_ticker) y
		 where x.coin_delete_yn = 'N'
		   and x.coin_ticker = y.coin_ticker
		 order by cast(y.c_price as numeric) desc
	</select>
	
	<select id="MainLiveRankList" resultType="HashMap" parameterType="HashMap">
		select cast(ROW_NUMBER() OVER (ORDER BY cast(x.o_c_price_rate as numeric) desc) as varchar) AS ranking
			 , x.datetime_kst, x.coin_ticker, x.coin_kor_name, x.o_price, x.c_price, x.o_c_price_rate
		  from (
				select x.datetime_kst, x.coin_ticker, x.coin_kor_name, x.oo_price o_price, x.cc_price c_price
					 , cast((ROUND(((cast(x.cc_price as numeric)-cast(x.oo_price as numeric))/cast(x.oo_price as numeric))*100,1)) as varchar) o_c_price_rate
				  from (
						select x.datetime_kst, x.coin_ticker
							 , (select a.coin_kor_name from upbit_coin_info a where a.coin_ticker = x.coin_ticker) coin_kor_name
						     , (select a.o_price from upbit_coin_min a where a.coin_ticker = x.coin_ticker and a.datetime_utc ilike '${search_date}%' order by a.datetime_utc asc limit 1) oo_price
							 , (select a.c_price from upbit_coin_min a where a.coin_ticker = x.coin_ticker order by a.datetime_utc desc limit 1) cc_price
						  from upbit_coin_min x
							 , (select coin_ticker, max(datetime_utc) recently_datetime_utc
						  	      from upbit_coin_min
						 	     where datetime_utc ilike '${search_date}%'
							     group by coin_ticker) y
						 where x.coin_ticker = y.coin_ticker
						   and x.datetime_utc = y.recently_datetime_utc
				   		) x
				) x
		 order by cast(x.o_c_price_rate as numeric) desc
	</select>
	
	<select id="ExcelMake_Daily_Result" resultType="HashMap" parameterType="HashMap">
		 select cast((sum((select count(*) from upbit_coin_day y where x.coin_ticker = y.coin_ticker and x.datetime_kst= y.datetime_kst))) as varchar) total_count
		      , cast((sum((select count(*) from upbit_coin_day y where x.coin_ticker = y.coin_ticker and cast(x.o_price as numeric) <![CDATA[ < ]]> cast(x.c_price as numeric) and x.datetime_kst= y.datetime_kst))) as varchar) increase_count
		      , cast((sum((select count(*) from upbit_coin_day y where x.coin_ticker = y.coin_ticker and cast(x.o_price as numeric) <![CDATA[ > ]]> cast(x.c_price as numeric) and x.datetime_kst= y.datetime_kst))) as varchar) degradation_count
		      , cast((sum((select count(*) from upbit_coin_day y where x.coin_ticker = y.coin_ticker and cast(x.o_price as numeric) <![CDATA[ = ]]> cast(x.c_price as numeric) and x.datetime_kst= y.datetime_kst))) as varchar) flat_count
		      , coalesce((select array_to_string(array_agg(replace(y.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) y where cast(y.o_price as numeric) <![CDATA[ < ]]> cast(y.c_price as numeric) and left(y.datetime_utc, 10) = #{date}), '') increase_ticker
		      , coalesce((select array_to_string(array_agg(replace(y.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) y where cast(y.o_price as numeric) <![CDATA[ > ]]> cast(y.c_price as numeric) and left(y.datetime_utc, 10) = #{date}), '') degradation_ticker
		      , coalesce((select array_to_string(array_agg(replace(y.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) y where cast(y.o_price as numeric) <![CDATA[ = ]]> cast(y.c_price as numeric) and left(y.datetime_utc, 10) = #{date}), '') flat_ticker
		   from upbit_coin_day x
		  where left(x.datetime_utc, 10) = #{date}	</select>
	
	<select id="ExcelMake_Daily" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker, x.coin_kor_name, x.coin_eng_name, x.o_price, x.c_price, x.l_price, x.h_price
			 , coalesce(x.coin_price_min_time, '') coin_price_min_time, coalesce(x.coin_price_max_time, '') coin_price_max_time
			 , coalesce(x.coin_volume_min_time, '') coin_volume_min_time, coalesce(x.coin_volume_max_time, '') coin_volume_max_time
			 , cast((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,1)) as varchar) open_close_rate
			 , cast((cast(x.c_price as numeric)-cast(x.o_price as numeric)) as varchar) open_close_calc
			 , cast(ROUND(((((cast(x.max_price as numeric) - cast(x.min_price as numeric))/ cast(x.min_price as numeric))) * 100), 1) as varchar) lowest_highest_fluctuation
			 , cast((cast(x.max_price as numeric)-cast(x.min_price as numeric)) as varchar) lowest_highest_calc
		  from (
				select x.coin_ticker, y.coin_kor_name, y.coin_eng_name
					 , case when position('.0' in cast(min(cast(x.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(x.l_price as numeric)) as varchar))-2) then replace((cast(min(cast(x.l_price as numeric)) as varchar)), '.0', '') else cast(min(cast(x.l_price as numeric)) as varchar) end  min_price
					 , case when position('.0' in cast(max(cast(x.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(x.h_price as numeric)) as varchar))-2) then replace((cast(max(cast(x.h_price as numeric)) as varchar)), '.0', '') else cast(max(cast(x.h_price as numeric)) as varchar) end  max_price
		             , (select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
		             	  from upbit_coin_day z 
		             	 where x.coin_ticker = z.coin_ticker 
		             	   and left(z.datetime_kst, 10) = #{date}
		             	 order by z.datetime_utc desc 
		             	 limit 1) c_price
		             , (select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
		                  from upbit_coin_day z 
		                 where x.coin_ticker = z.coin_ticker 
		                   and left(z.datetime_utc, 10) = #{date}
		                 order by z.datetime_utc asc 
		                 limit 1) o_price
					 , (select case when position('.0' in cast(min(cast(z.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(z.l_price as numeric)) as varchar))-2) then replace(cast(min(cast(z.l_price as numeric)) as varchar), '.0', '') else cast(min(cast(z.l_price as numeric)) as varchar) end 
					 	  from upbit_coin_day z
					 	 where x.coin_ticker = z.coin_ticker 
					 	   and left(z.datetime_utc, 10) = #{date}
					 	 limit 1) l_price
		     		 , (select case when position('.0' in cast(max(cast(z.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(z.h_price as numeric)) as varchar))-2) then replace(cast(max(cast(z.h_price as numeric)) as varchar), '.0', '') else cast(max(cast(z.h_price as numeric)) as varchar) end 
		     		 	  from upbit_coin_day z 
		     		 	 where x.coin_ticker = z.coin_ticker 
		     		 	   and left(z.datetime_utc, 10) = #{date}
		     		 	 limit 1) h_price
		     		 , (select substring(z.datetime_kst, 12,2)
						  from upbit_coin_min z
						 where x.coin_ticker = z.coin_ticker
						   and left(z.datetime_utc, 10) = #{date}
						 group by substring(z.datetime_utc, 12,2), substring(z.datetime_kst, 12,2)
						 order by sum(cast(z.trade_volume as numeric)) desc
						 limit 1) coin_volume_max_time
				     , (select substring(z.datetime_kst, 12,2)
						  from upbit_coin_min z
						 where x.coin_ticker = z.coin_ticker
						   and left(z.datetime_utc, 10) = #{date}
						 group by substring(z.datetime_utc, 12,2), substring(z.datetime_kst, 12,2)
						 order by sum(cast(z.trade_volume as numeric)) asc
						 limit 1) coin_volume_min_time
					 , (select substring(z.datetime_kst, 12,5)
		 			      from upbit_coin_min z
		 			     where x.coin_ticker = z.coin_ticker
		 			       and left(z.datetime_utc, 10) = #{date}
		 			       and cast(cast(z.l_price as numeric) as varchar) = cast(min(cast(x.l_price as numeric)) as varchar)
		 			     order by substring(z.datetime_utc, 12,2)
		 			     limit 1) coin_price_min_time
		 			 , (select substring(z.datetime_kst, 12,5)
		 			      from upbit_coin_min z
		 			     where x.coin_ticker = z.coin_ticker
		 			       and left(z.datetime_utc, 10) = #{date}
		 			       and cast(cast(z.h_price as numeric) as varchar) = cast(max(cast(x.h_price as numeric)) as varchar)
		 			     order by substring(z.datetime_utc, 12,2)
		 			     limit 1) coin_price_max_time
				  from upbit_coin_day x, upbit_coin_info y
				 where x.coin_ticker = y.coin_ticker
				 <if test='coin_ticker != null and coin_ticker != "" '>
				   and replace(x.coin_ticker, 'KRW-', '') in ('${coin_ticker}')
				 </if>
				   and left(x.datetime_utc, 10) = #{date}
				 group by x.coin_ticker, y.coin_kor_name, y.coin_eng_name
		 	   ) x
		  where ((x.coin_price_min_time <![CDATA[ <= ]]> x.coin_price_max_time and x.coin_ticker != 'KRW-BTC') or (x.coin_ticker = 'KRW-BTC'))
		  order by case x.coin_ticker when 'KRW-BTC' then 0 else 1 end
		  	  , ((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,1))+ROUND(((((cast(x.max_price as numeric) - cast(x.min_price as numeric))/ cast(x.min_price as numeric))) * 100), 1)) desc
		  limit 4
	</select>
	
	<select id="ExcelMake_Daily_Sub" resultType="HashMap" parameterType="HashMap">
		  select case when cast(substring(x.datetime_utc, 12,2) as integer) >= 0 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4 then '09:00'
			    	  when cast(substring(x.datetime_utc, 12,2) as integer) >= 4 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8 then '13:00'
			          when cast(substring(x.datetime_utc, 12,2) as integer) >= 8 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12 then '17:00'
			          when cast(substring(x.datetime_utc, 12,2) as integer) >= 12 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16 then '21:00'
			          when cast(substring(x.datetime_utc, 12,2) as integer) >= 16 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20 then '01:00'
			          when cast(substring(x.datetime_utc, 12,2) as integer) >= 20 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24 then '05:00'
			      end day_time
			   , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_0_4
		       , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_4_8
		       , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_8_12
		       , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_12_16
		       , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_16_20
		       , coalesce((select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24
				       	   order by z.datetime_kst 
				     	   limit 1), '0') o_price_20_24
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_0_4
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_4_8
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_8_12
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_12_16
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_16_20
		       , coalesce((select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24
				       	   order by z.datetime_kst desc 
				     	   limit 1), '0') c_price_20_24
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_0_4 
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_4_8
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_8_12
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_12_16
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_16_20
		       , coalesce((select case when position('.0' in cast(cast(z.h_price as numeric) as varchar)) > (char_length(cast(cast(z.h_price as numeric) as varchar))-2) then replace((cast(cast(z.h_price as numeric) as varchar)), '.0', '') else cast(cast(z.h_price as numeric) as varchar) end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24
				       	   order by cast(z.h_price as numeric) desc
				     	   limit 1), '0') h_price_20_24
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end 
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_0_4
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_4_8
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_8_12
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_12_16
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_16_20
		       , coalesce((select case when position('.0' in cast(cast(z.l_price as numeric) as varchar)) > (char_length(cast(cast(z.l_price as numeric) as varchar))-2) then replace((cast(cast(z.l_price as numeric) as varchar)), '.0', '') else cast(cast(z.l_price as numeric) as varchar) end
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24
				       	   order by cast(z.l_price as numeric) asc
				     	   limit 1), '0') l_price_20_24
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_0_4
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_4_8
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_8_12
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_12_16
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_16_20
		       , coalesce((select cast((round(sum(cast(z.trade_volume as numeric)),2)) as varchar)
				       	    from upbit_coin_min z 
				       	   where z.coin_ticker = x.coin_ticker
				       	     and left(z.datetime_utc, 10) = #{date}
				       	     and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(z.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24
				       	   group by z.datetime_utc, z.datetime_kst
				     	   order by z.datetime_kst desc
				     	   limit 1), '0') trade_volume_20_24
		    from upbit_coin_min x 
		   where x.coin_ticker = #{coin_ticker}
		     and left(x.datetime_utc, 10) = #{date}
		   group by x.coin_ticker, left(x.datetime_utc, 10)
		   		  , case when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 0 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 4 then '09:00'
				    	 when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 4 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 8 then '13:00'
				         when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 8 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 12 then '17:00'
				         when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 12 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 16 then '21:00'
				         when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 16 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 20 then '01:00'
				         when cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ >= ]]> 20 and cast(substring(x.datetime_utc, 12,2) as integer) <![CDATA[ < ]]> 24 then '05:00' end
	</select>
	
	<select id="ExcelMake_Daily_Ranking" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker, x.coin_kor_name || '[' || x.coin_ticker || ']' coin_name
			 , x.o_price, x.l_price, x.h_price, x.c_price
			 , x.before_o_price, x.before_l_price, x.before_h_price, x.before_c_price
			 , cast(round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) as varchar) o_c_price_rate
			 , cast(round((((cast(x.before_c_price as numeric) - cast(x.before_o_price as numeric))/cast(x.before_o_price as numeric))*100),2) as varchar) before_o_c_price_rate
			 , cast((RANK () OVER (ORDER BY round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) desc)) as varchar) ranking
			 , cast((RANK () OVER (ORDER BY round((((cast(x.before_c_price as numeric) - cast(x.before_o_price as numeric))/cast(x.before_o_price as numeric))*100),2) desc)) as varchar) before_ranking
		  from (
				select replace(x.coin_ticker, 'KRW-', '') coin_ticker, x.coin_kor_name
					 , (select case when position('.0' in y.o_price) > (char_length(y.o_price)-2) then replace(y.o_price, '.0', '') else y.o_price end
					 	  from upbit_coin_min y 
					 	 where y.coin_ticker = x.coin_ticker 
					 	   and left(y.datetime_kst, 10) = #{date}
					 	 order by y.datetime_kst 
					 	 limit 1) o_price
				 	 , (select case when position('.0' in y.l_price) > (char_length(y.l_price)-2) then replace(y.l_price, '.0', '') else y.l_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_kst, 10) = #{date}
				 	 	 order by cast(y.l_price as numeric) asc 
				 	 	 limit 1) l_price
				 	 , (select case when position('.0' in y.h_price) > (char_length(y.h_price)-2) then replace(y.h_price, '.0', '') else y.h_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_kst, 10) = #{date}
						 order by cast(y.h_price as numeric) desc
						 limit 1) h_price
				 	 , (select case when position('.0' in y.c_price) > (char_length(y.c_price)-2) then replace(y.c_price, '.0', '') else y.c_price end
				 	      from upbit_coin_min y
						 where y.coin_ticker = x.coin_ticker 
						   and left(y.datetime_kst, 10) = #{date}
						 order by y.datetime_kst desc 
						 limit 1) c_price
					 , (select case when position('.0' in y.o_price) > (char_length(y.o_price)-2) then replace(y.o_price, '.0', '') else y.o_price end
					 	  from upbit_coin_min y 
					 	 where y.coin_ticker = x.coin_ticker 
					 	   and left(y.datetime_kst, 10) = #{yesterday}
					 	 order by y.datetime_kst 
					 	 limit 1) before_o_price
				 	 , (select case when position('.0' in y.l_price) > (char_length(y.l_price)-2) then replace(y.l_price, '.0', '') else y.l_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_kst, 10) = #{yesterday}
				 	 	 order by cast(y.l_price as numeric) asc 
				 	 	 limit 1) before_l_price
				 	 , (select case when position('.0' in y.h_price) > (char_length(y.h_price)-2) then replace(y.h_price, '.0', '') else y.h_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_kst, 10) = #{yesterday}
						 order by cast(y.h_price as numeric) desc
						 limit 1) before_h_price
				 	 , (select case when position('.0' in y.c_price) > (char_length(y.c_price)-2) then replace(y.c_price, '.0', '') else y.c_price end
				 	      from upbit_coin_min y
						 where y.coin_ticker = x.coin_ticker 
						   and left(y.datetime_kst, 10) = #{yesterday}
						 order by y.datetime_kst desc 
						 limit 1) before_c_price
				  from upbit_coin_info x
				 where x.coin_delete_yn = 'N'
		 	   ) X
		  where x.o_price != '' and x.l_price != '' and x.h_price != '' and x.c_price != '' and x.before_o_price != '' and x.before_l_price != '' and x.before_h_price != '' and x.before_c_price != ''
		  order by round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) desc, (cast(x.c_price as numeric) - cast(x.o_price as numeric)) desc
	</select>
	
	<select id="ExcelMake_Weekly_Result" resultType="HashMap" parameterType="HashMap">
		select cast(sum(cast(x.total_count as integer)) as varchar) total_count
			 , cast(sum(cast(x.increase_count as integer)) as varchar) increase_count
			 , cast(sum(cast(x.degradation_count as integer)) as varchar) degradation_count
			 , cast(sum(cast(x.flat_count as integer)) as varchar) flat_count
			 , coalesce((select array_to_string(array_agg(replace(x.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) x, (select * from upbit_coin_day order by coin_ticker) y where x.coin_ticker = y.coin_ticker and left(x.datetime_utc, 10) = #{std_date} and left(y.datetime_utc, 10) = #{end_date} and cast(x.o_price as numeric) <![CDATA[ < ]]> cast(y.c_price as numeric)), '') increase_ticker
	 		 , coalesce((select array_to_string(array_agg(replace(x.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) x, (select * from upbit_coin_day order by coin_ticker) y where x.coin_ticker = y.coin_ticker and left(x.datetime_utc, 10) = #{std_date} and left(y.datetime_utc, 10) = #{end_date} and cast(x.o_price as numeric) <![CDATA[ > ]]> cast(y.c_price as numeric)), '') degradation_ticker
	 		 , coalesce((select array_to_string(array_agg(replace(x.coin_ticker, 'KRW-', '')), ', ') from (select * from upbit_coin_day order by coin_ticker) x, (select * from upbit_coin_day order by coin_ticker) y where x.coin_ticker = y.coin_ticker and left(x.datetime_utc, 10) = #{std_date} and left(y.datetime_utc, 10) = #{end_date} and cast(x.o_price as numeric) <![CDATA[ = ]]> cast(y.c_price as numeric)), '') flat_ticker
		  from (
				select '1' as total_count
				     , case when cast(x.o_price as numeric) <![CDATA[ < ]]> cast(x.c_price as numeric) then '1' else '0' end increase_count
				     , case when cast(x.o_price as numeric) <![CDATA[ > ]]> cast(x.c_price as numeric) then '1' else '0' end degradation_count
				     , case when cast(x.o_price as numeric) <![CDATA[ = ]]> cast(x.c_price as numeric) then '1' else '0' end flat_count
				  from (
						select x.coin_ticker
							 , (select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
							 	  from upbit_coin_day z 
							 	 where x.coin_ticker = z.coin_ticker 
							 	   and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								   and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
							 	 order by z.datetime_kst desc 
							 	 limit 1) c_price
							 , (select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
							      from upbit_coin_day z 
							     where x.coin_ticker = z.coin_ticker 
							       and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								   and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
							     order by z.datetime_kst asc 
							     limit 1) o_price  
						  from upbit_coin_day x
						 where left(x.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						   and left(x.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 group by x.coin_ticker
				 		) x
		 	) x
	</select>
	
	<select id="ExcelMake_Weekly" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker, x.gijun_date, x.coin_kor_name, x.coin_eng_name, x.max_price, x.min_price, x.max_date, x.min_date, x.o_price, x.c_price, x.l_price, x.h_price
			 , coalesce(x.o_c_price_rate_5_date, '') o_c_price_rate_5_date, coalesce(x.o_c_price_rate_10_date, '') o_c_price_rate_10_date, coalesce(x.o_c_price_rate_15_date, '') o_c_price_rate_15_date
	 		 , coalesce(x.o_c_price_rate_20_date, '') o_c_price_rate_20_date, coalesce(x.o_c_price_rate_25_date, '') o_c_price_rate_25_date, coalesce(x.o_c_price_rate_30_date, '') o_c_price_rate_30_date
	 		 , coalesce(cast(x.o_c_price_rate_5_count as varchar), '0') o_c_price_rate_5_count, coalesce(cast(x.o_c_price_rate_10_count as varchar), '0') o_c_price_rate_10_count, coalesce(cast(x.o_c_price_rate_15_count as varchar), '0') o_c_price_rate_15_count
	 		 , coalesce(cast(x.o_c_price_rate_20_count as varchar), '0') o_c_price_rate_20_count, coalesce(cast(x.o_c_price_rate_25_count as varchar), '0') o_c_price_rate_25_count, coalesce(cast(x.o_c_price_rate_30_count as varchar), '0') o_c_price_rate_30_count
			 , cast((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,1)) as varchar) open_close_rate
			 , cast((cast(x.c_price as numeric)-cast(x.o_price as numeric)) as varchar) open_close_calc
			 , cast(ROUND(((((cast(x.max_price as numeric) - cast(x.min_price as numeric))/ cast(x.min_price as numeric))) * 100), 1) as varchar) lowest_highest_fluctuation
			 , cast((cast(x.max_price as numeric)-cast(x.min_price as numeric)) as varchar) lowest_highest_calc
		  from (
				select x.coin_ticker, y.coin_kor_name, y.coin_eng_name
					 , coalesce((select max(replace(a.datetime_kst, 'T09:00:00', '')) 
					 			   from upbit_coin_day a 
					 			  where a.coin_ticker = x.coin_ticker 
				 			     <if test='std_date != null and std_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								 </if>
								 <if test='end_date != null and end_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
								 </if>
					 			    and a.l_price = cast(min(cast(x.l_price as numeric)) as varchar)), '') min_date
			 		 , coalesce((select max(replace(a.datetime_kst, 'T09:00:00', '')) 
			 		 			   from upbit_coin_day a 
			 		 			  where a.coin_ticker = x.coin_ticker
			 		 			  <if test='std_date != null and std_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
								  </if>
								  <if test='end_date != null and end_date != "" '>
									and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
								  </if>
			 		 			    and a.h_price = cast(max(cast(x.h_price as numeric)) as varchar)), '') max_date
					 , case when position('.0' in cast(min(cast(x.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(x.l_price as numeric)) as varchar))-2) then replace((cast(min(cast(x.l_price as numeric)) as varchar)), '.0', '') else cast(min(cast(x.l_price as numeric)) as varchar) end  min_price
					 , case when position('.0' in cast(max(cast(x.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(x.h_price as numeric)) as varchar))-2) then replace((cast(max(cast(x.h_price as numeric)) as varchar)), '.0', '') else cast(max(cast(x.h_price as numeric)) as varchar) end  max_price
		             , (select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end 
		             	  from upbit_coin_day z 
		             	 where x.coin_ticker = z.coin_ticker 
		             	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		             	 order by z.datetime_kst desc 
		             	 limit 1) c_price
		             , (select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end 
		                  from upbit_coin_day z 
		                 where x.coin_ticker = z.coin_ticker 
		                 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		                 order by z.datetime_kst asc 
		                 limit 1) o_price
					 , (select case when position('.0' in cast(min(cast(z.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(z.l_price as numeric)) as varchar))-2) then replace(cast(min(cast(z.l_price as numeric)) as varchar), '.0', '') else cast(min(cast(z.l_price as numeric)) as varchar) end 
					 	  from upbit_coin_day z
					 	 where x.coin_ticker = z.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	 limit 1) l_price
		     		 , (select case when position('.0' in cast(max(cast(z.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(z.h_price as numeric)) as varchar))-2) then replace(cast(max(cast(z.h_price as numeric)) as varchar), '.0', '') else cast(max(cast(z.h_price as numeric)) as varchar) end 
		     		 	  from upbit_coin_day z 
		     		 	 where x.coin_ticker = z.coin_ticker 
		     		 	 <if test='std_date != null and std_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(z.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
		     		 	 limit 1) h_price
		 			 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	 order by a.datetime_kst desc 
					 	 limit 1) gijun_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 5 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_5_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 10 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_10_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 15 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_15_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 20 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_20_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 25 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_25_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 30 
					 	 order by a.datetime_kst desc limit 1) o_c_price_rate_30_date
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 5) o_c_price_rate_5_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 10) o_c_price_rate_10_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 15) o_c_price_rate_15_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 20) o_c_price_rate_20_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 25) o_c_price_rate_25_count
					 , (select count(*) 
					 	  from upbit_coin_day a 
					 	 where x.coin_ticker = a.coin_ticker 
					 	 <if test='std_date != null and std_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
						 </if>
						 <if test='end_date != null and end_date != "" '>
							and left(a.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 </if>
					 	   and cast(a.o_c_price_rate as numeric) <![CDATA[ >= ]]> 30) o_c_price_rate_30_count
				  from upbit_coin_day x, upbit_coin_info y
				 where x.coin_ticker = y.coin_ticker
				 <if test='std_date != null and std_date != "" '>
					and left(x.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
				 </if>
				 <if test='end_date != null and end_date != "" '>
					and left(x.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
				 </if>
				 <if test='coin_ticker != null and coin_ticker != "" '>
				   and replace(x.coin_ticker, 'KRW-', '') in ('${coin_ticker}')
				 </if>
				 group by x.coin_ticker, y.coin_kor_name, y.coin_eng_name
		 	   ) x
		  where ((x.min_date <![CDATA[ <= ]]> x.max_date and x.coin_ticker != 'KRW-BTC') or (x.coin_ticker = 'KRW-BTC'))
		  order by case x.coin_ticker when 'KRW-BTC' then 0 else 1 end
		  	  , ((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,1))+ROUND(((((cast(x.max_price as numeric) - cast(x.min_price as numeric))/ cast(x.min_price as numeric))) * 100), 1)) desc
  		  limit 4
	</select>
	
	<select id="ExcelMake_Weekly_Sub" resultType="HashMap" parameterType="HashMap">
		select replace(x.datetime_kst, 'T09:00:00', '') datetime_kst, x.o_c_price_rate
		 	 , case when position('.0' in x.o_price) > (char_length(x.o_price)-2) then replace(x.o_price, '.0', '') else x.o_price end o_price
		 	 , case when position('.0' in x.c_price) > (char_length(x.c_price)-2) then replace(x.c_price, '.0', '') else x.c_price end c_price
		 	 , case when position('.0' in x.l_price) > (char_length(x.l_price)-2) then replace(x.l_price, '.0', '') else x.l_price end l_price
		 	 , case when position('.0' in x.h_price) > (char_length(x.h_price)-2) then replace(x.h_price, '.0', '') else x.h_price end h_price
	  	  from upbit_coin_day x
		 where coin_ticker = #{coin_ticker}
	       and left(x.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		   and left(x.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
	     order by x.datetime_kst asc
	</select>
	
	<select id="ExcelMake_Weekly_Ranking" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker, x.coin_kor_name || '[' || x.coin_ticker || ']' coin_name
			 , x.o_price, x.l_price, x.h_price, x.c_price
			 , x.before_o_price, x.before_l_price, x.before_h_price, x.before_c_price
			 , cast(round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) as varchar) o_c_price_rate
			 , cast(round((((cast(x.before_c_price as numeric) - cast(x.before_o_price as numeric))/cast(x.before_o_price as numeric))*100),2) as varchar) before_o_c_price_rate
			 , cast((RANK () OVER (ORDER BY round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) desc)) as varchar) ranking
			 , cast((RANK () OVER (ORDER BY round((((cast(x.before_c_price as numeric) - cast(x.before_o_price as numeric))/cast(x.before_o_price as numeric))*100),2) desc)) as varchar) before_ranking
		  from (
				select replace(x.coin_ticker, 'KRW-', '') coin_ticker, x.coin_kor_name
					 , (select case when position('.0' in y.o_price) > (char_length(y.o_price)-2) then replace(y.o_price, '.0', '') else y.o_price end
					 	  from upbit_coin_min y 
					 	 where y.coin_ticker = x.coin_ticker 
					 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
					 	 order by y.datetime_utc 
					 	 limit 1) o_price
				 	 , (select case when position('.0' in y.l_price) > (char_length(y.l_price)-2) then replace(y.l_price, '.0', '') else y.l_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
				 	 	 order by cast(y.l_price as numeric) asc 
				 	 	 limit 1) l_price
				 	 , (select case when position('.0' in y.h_price) > (char_length(y.h_price)-2) then replace(y.h_price, '.0', '') else y.h_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 order by cast(y.h_price as numeric) desc
						 limit 1) h_price
				 	 , (select case when position('.0' in y.c_price) > (char_length(y.c_price)-2) then replace(y.c_price, '.0', '') else y.c_price end
				 	      from upbit_coin_min y
						 where y.coin_ticker = x.coin_ticker 
						   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
						 order by y.datetime_kst desc 
						 limit 1) c_price
					 , (select case when position('.0' in y.o_price) > (char_length(y.o_price)-2) then replace(y.o_price, '.0', '') else y.o_price end
					 	  from upbit_coin_min y 
					 	 where y.coin_ticker = x.coin_ticker 
					 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{past_std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{past_end_date}
					 	 order by y.datetime_utc 
					 	 limit 1) before_o_price
				 	 , (select case when position('.0' in y.l_price) > (char_length(y.l_price)-2) then replace(y.l_price, '.0', '') else y.l_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{past_std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{past_end_date}
				 	 	 order by cast(y.l_price as numeric) asc 
				 	 	 limit 1) before_l_price
				 	 , (select case when position('.0' in y.h_price) > (char_length(y.h_price)-2) then replace(y.h_price, '.0', '') else y.h_price end
				 	 	  from upbit_coin_min y 
				 	 	 where y.coin_ticker = x.coin_ticker 
				 	 	   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{past_std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{past_end_date}
						 order by cast(y.h_price as numeric) desc
						 limit 1) before_h_price
				 	 , (select case when position('.0' in y.c_price) > (char_length(y.c_price)-2) then replace(y.c_price, '.0', '') else y.c_price end
				 	      from upbit_coin_min y
						 where y.coin_ticker = x.coin_ticker 
						   and left(y.datetime_utc, 10) <![CDATA[ >= ]]> #{past_std_date}
		                   and left(y.datetime_utc, 10) <![CDATA[ <= ]]> #{past_end_date}
						 order by y.datetime_utc desc 
						 limit 1) before_c_price
				  from upbit_coin_info x
				 where x.coin_delete_yn = 'N'
		 	   ) X
		  where x.o_price != '' and x.l_price != '' and x.h_price != '' and x.c_price != '' and x.before_o_price != '' and x.before_l_price != '' and x.before_h_price != '' and x.before_c_price != ''
		  order by round((((cast(x.c_price as numeric) - cast(x.o_price as numeric))/cast(x.o_price as numeric))*100),2) desc, (cast(x.c_price as numeric) - cast(x.o_price as numeric)) desc
	</select>
	
	<select id="ExcelMake_Monthly_Sub" resultType="HashMap" parameterType="HashMap">
		select replace(x.datetime_kst, 'T09:00:00', '') datetime_kst, x.o_c_price_rate
		 	 , case when position('.0' in x.o_price) > (char_length(x.o_price)-2) then replace(x.o_price, '.0', '') else x.o_price end o_price
		 	 , case when position('.0' in x.c_price) > (char_length(x.c_price)-2) then replace(x.c_price, '.0', '') else x.c_price end c_price
		 	 , case when position('.0' in x.l_price) > (char_length(x.l_price)-2) then replace(x.l_price, '.0', '') else x.l_price end l_price
		 	 , case when position('.0' in x.h_price) > (char_length(x.h_price)-2) then replace(x.h_price, '.0', '') else x.h_price end h_price
	  	  from upbit_coin_day x
		 where coin_ticker = #{coin_ticker}
	       and left(x.datetime_utc, 10) <![CDATA[ >= ]]> #{std_date}
		   and left(x.datetime_utc, 10) <![CDATA[ <= ]]> #{end_date}
	     order by cast(x.o_c_price_rate as numeric) desc 
 		 limit 7
	</select>
</mapper>