<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.diff._private.Mapper.CoinMapper">
	
	<select id="MainGridList" resultType="HashMap" parameterType="HashMap">
		select x.coin_ticker id, x.gijun_date, x.coin_kor_name, x.coin_eng_name, x.max_price, x.min_price, x.o_price, x.c_price, x.l_price, x.h_price, x.trade_volume
			 , coalesce(x.o_c_price_rate_5, '') o_c_price_rate_5, coalesce(x.o_c_price_rate_10, '') o_c_price_rate_10, coalesce(x.o_c_price_rate_15, '') o_c_price_rate_15
	 		 , coalesce(x.o_c_price_rate_20, '') o_c_price_rate_20, coalesce(x.o_c_price_rate_25, '') o_c_price_rate_25, coalesce(x.o_c_price_rate_30, '') o_c_price_rate_30
			 , cast((ROUND(((cast(x.c_price as numeric)-cast(x.o_price as numeric))/cast(x.o_price as numeric))*100,2)) as varchar) open_close_rate
			 , cast(ROUND((((cast(x.c_price as numeric) / (cast(x.min_price as numeric) + cast(x.max_price as numeric)))) * 100), 1) as varchar) highest_lowest_100per
			 , cast((ROUND(((((cast(x.max_price as numeric) - cast(x.c_price as numeric)) / cast(x.max_price as numeric))) * 100), 1)) as varchar) highest_decline_rate
			 , cast((ROUND(((((cast(x.c_price as numeric) - cast(x.min_price as numeric)) / cast(x.min_price as numeric))) * 100), 1)) as varchar) lowest_rise_rate
		  from (
				select x.coin_ticker, y.coin_kor_name, y.coin_eng_name
					 , case when position('.0' in cast(min(cast(x.l_price as numeric)) as varchar)) > (char_length(cast(min(cast(x.l_price as numeric)) as varchar))-2) then replace((cast(min(cast(x.l_price as numeric)) as varchar)), '.0', '') else cast(min(cast(x.l_price as numeric)) as varchar) end  min_price
					 , case when position('.0' in cast(max(cast(x.h_price as numeric)) as varchar)) > (char_length(cast(max(cast(x.h_price as numeric)) as varchar))-2) then replace((cast(max(cast(x.h_price as numeric)) as varchar)), '.0', '') else cast(max(cast(x.h_price as numeric)) as varchar) end  max_price
		             , (select case when position('.0' in z.c_price) > (char_length(z.c_price)-2) then replace(z.c_price, '.0', '') else z.c_price end from coin_days z where x.coin_ticker = z.coin_ticker order by z.datetime_kst desc limit 1) c_price
		             , (select case when position('.0' in z.o_price) > (char_length(z.o_price)-2) then replace(z.o_price, '.0', '') else z.o_price end from coin_days z where x.coin_ticker = z.coin_ticker order by z.datetime_kst desc limit 1) o_price
		             , (select case when position('.0' in z.l_price) > (char_length(z.l_price)-2) then replace(z.l_price, '.0', '') else z.l_price end from coin_days z where x.coin_ticker = z.coin_ticker order by z.datetime_kst desc limit 1) l_price
		             , (select case when position('.0' in z.h_price) > (char_length(z.h_price)-2) then replace(z.h_price, '.0', '') else z.h_price end from coin_days z where x.coin_ticker = z.coin_ticker order by z.datetime_kst desc limit 1) h_price
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker order by a.datetime_kst desc limit 1) gijun_date
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 5 and cast(a.o_c_price_rate as numeric) &lt; 10 order by a.datetime_kst desc limit 1) o_c_price_rate_5
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 10 and cast(a.o_c_price_rate as numeric) &lt; 15 order by a.datetime_kst desc limit 1) o_c_price_rate_10
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 15 and cast(a.o_c_price_rate as numeric) &lt; 20 order by a.datetime_kst desc limit 1) o_c_price_rate_15
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 20 and cast(a.o_c_price_rate as numeric) &lt; 25 order by a.datetime_kst desc limit 1) o_c_price_rate_20
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 25 and cast(a.o_c_price_rate as numeric) &lt; 30 order by a.datetime_kst desc limit 1) o_c_price_rate_25
					 , (select replace(a.datetime_kst, 'T09:00:00', '') from coin_days a where x.coin_ticker = a.coin_ticker and cast(a.o_c_price_rate as numeric) >= 30 order by a.datetime_kst desc limit 1) o_c_price_rate_30
					 , (select case when cast(trade_volume as numeric) > 100000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000)) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 10000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000), 1) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 1000000000 then cast(ROUND((cast(trade_volume as numeric)/1000000000), 2) as varchar) || 'B'
						 			when cast(trade_volume as numeric) > 100000000 then cast(ROUND((cast(trade_volume as numeric)/1000000)) as varchar) || 'M'
						 			when cast(trade_volume as numeric) > 10000000 then cast(ROUND((cast(trade_volume as numeric)/1000000), 1) as varchar) || 'M'
									when cast(trade_volume as numeric) > 1000000 then cast(ROUND((cast(trade_volume as numeric)/1000000), 2) as varchar) || 'M'
									when cast(trade_volume as numeric) > 100000 then cast(ROUND((cast(trade_volume as numeric)/1000)) as varchar) || 'K'
									when cast(trade_volume as numeric) > 10000 then cast(ROUND((cast(trade_volume as numeric)/1000), 1) as varchar) || 'K'
								    else cast(ROUND((cast(trade_volume as numeric)/1000), 2) as varchar) || 'K' end 
						  from coin_days z where x.coin_ticker = z.coin_ticker order by z.datetime_kst desc limit 1)  trade_volume
				  from coin_days x, coin_info y
				 where x.coin_ticker = y.coin_ticker
				 group by x.coin_ticker, y.coin_kor_name, y.coin_eng_name
		 	   ) x
		  order by cast(x.c_price as numeric) desc
	</select>
	
	<select id="CoinInfo" resultType="HashMap">
		select coin_ticker, coin_kor_name, coin_eng_name
		  from coin_info
		 where coin_delete_yn = 'N'
	</select>

</mapper>